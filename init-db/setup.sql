-- ========================================================
-- SETUP GENERAL DE BASE DE DATOS - MICROSERVICIOS
-- ========================================================
-- Incluye:
--  - Huespedes
--  - Habitaciones
--  - Reservas
--  - Auth Server (Seguridad)
--  - Borrado lÃ³gico con ESTADO_REGISTRO
-- ========================================================


-- ========================================================
-- 1. ESQUEMA DE HUESPEDES
-- ========================================================
CREATE USER HUESPEDES_USER IDENTIFIED BY "HuespedesPass123";
GRANT CONNECT, RESOURCE, DBA TO HUESPEDES_USER;
ALTER USER HUESPEDES_USER QUOTA UNLIMITED ON USERS;

CREATE TABLE HUESPEDES_USER.HUESPEDES (
    ID_HUESPED       NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMBRE           VARCHAR2(100) NOT NULL,
    APELLIDO_PATERNO VARCHAR2(100) NOT NULL,
    APELLIDO_MATERNO VARCHAR2(100) NOT NULL,
    EMAIL            VARCHAR2(150) NOT NULL,
    TELEFONO         VARCHAR2(20) NOT NULL,
    DOCUMENTO        VARCHAR2(50) NOT NULL,
    NACIONALIDAD     VARCHAR2(50) NOT NULL,
    FECHA_REGISTRO   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ESTADO_REGISTRO  VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL,
    CONSTRAINT CHK_ESTADO_REG_HUESPED
        CHECK (ESTADO_REGISTRO IN ('ACTIVO', 'ELIMINADO'))
);


-- ========================================================
-- 2. ESQUEMA DE HABITACIONES
-- ========================================================
CREATE USER HABITACIONES_USER IDENTIFIED BY "HabitacionesPass123";
GRANT CONNECT, RESOURCE, DBA TO HABITACIONES_USER;
ALTER USER HABITACIONES_USER QUOTA UNLIMITED ON USERS;

CREATE TABLE HABITACIONES_USER.HABITACIONES (
    ID_HABITACION   NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NUMERO          VARCHAR2(10) NOT NULL UNIQUE,
    TIPO            VARCHAR2(20) NOT NULL,
    PRECIO_NOCHE    NUMBER(10,2) NOT NULL,
    CAPACIDAD       NUMBER(2) NOT NULL,
    ESTADO          VARCHAR2(20) NOT NULL,
    ESTADO_REGISTRO VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL,
    CONSTRAINT CHK_TIPO_HAB
        CHECK (TIPO IN ('INDIVIDUAL', 'DOBLE', 'SUITE')),
    CONSTRAINT CHK_ESTADO_HAB
        CHECK (ESTADO IN ('DISPONIBLE', 'OCUPADA', 'LIMPIEZA', 'MANTENIMIENTO')),
    CONSTRAINT CHK_ESTADO_REG_HAB
        CHECK (ESTADO_REGISTRO IN ('ACTIVO', 'ELIMINADO'))
);


-- ========================================================
-- 3. ESQUEMA DE RESERVAS
-- ========================================================
CREATE USER RESERVAS_USER IDENTIFIED BY "ReservasPass123";
GRANT CONNECT, RESOURCE, DBA TO RESERVAS_USER;
ALTER USER RESERVAS_USER QUOTA UNLIMITED ON USERS;

CREATE TABLE RESERVAS_USER.RESERVAS (
    ID_RESERVA      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_HUESPED      NUMBER(10) NOT NULL,
    ID_HABITACION   NUMBER(10) NOT NULL,
    FECHA_ENTRADA   DATE NOT NULL,
    FECHA_SALIDA    DATE NOT NULL,
    CANT_NOCHES     NUMBER(3) NOT NULL,
    MONTO_TOTAL     NUMBER(10,2) NOT NULL,
    ESTADO          VARCHAR2(20) DEFAULT 'CONFIRMADA' NOT NULL,
    FECHA_CREACION  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ESTADO_REGISTRO VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL,
    CONSTRAINT CHK_FECHAS
        CHECK (FECHA_SALIDA > FECHA_ENTRADA),
    CONSTRAINT CHK_ESTADO_RES
        CHECK (ESTADO IN ('CONFIRMADA', 'EN_CURSO', 'FINALIZADA', 'CANCELADA')),
    CONSTRAINT CHK_ESTADO_REG_RES
        CHECK (ESTADO_REGISTRO IN ('ACTIVO', 'ELIMINADO'))
);


-- ========================================================
-- 4. ESQUEMA DE AUTHSERVER (SEGURIDAD)
-- ========================================================
CREATE USER SEGURIDAD_USER IDENTIFIED BY "SeguridadPass123";

GRANT CONNECT, RESOURCE TO SEGURIDAD_USER;
GRANT CREATE TABLE TO SEGURIDAD_USER;
GRANT CREATE SEQUENCE TO SEGURIDAD_USER;
GRANT CREATE VIEW TO SEGURIDAD_USER;
GRANT CREATE TRIGGER TO SEGURIDAD_USER;

ALTER USER SEGURIDAD_USER QUOTA UNLIMITED ON USERS;


-- ========================================================
-- FIN DEL SETUP
-- ========================================================
